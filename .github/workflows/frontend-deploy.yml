name: Deploy Frontend to Hostinger

on:
  push:
    branches:
      - main
    paths:
      - 'frontend/**'
      - '.github/workflows/frontend-deploy.yml'
  workflow_dispatch:

env:
  NODE_VERSION: '18.x'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        working-directory: ./frontend
        run: npm install

      - name: Create .env.production file
        working-directory: ./frontend
        run: |
          echo "REACT_APP_API_URL=${{ secrets.REACT_APP_API_URL }}" > .env.production
          echo "=== API URL VERIFICATION ==="
          echo "Full URL length: $(echo '${{ secrets.REACT_APP_API_URL }}' | wc -c)"
          echo "Last 50 chars: ...$(echo '${{ secrets.REACT_APP_API_URL }}' | tail -c 51)"
          echo "Ends with /api: $(echo '${{ secrets.REACT_APP_API_URL }}' | grep -q '/api$' && echo 'YES ✅' || echo 'NO ❌')"
          echo "Contains /api: $(echo '${{ secrets.REACT_APP_API_URL }}' | grep -q '/api' && echo 'YES' || echo 'NO')"
          cat .env.production

      - name: Verify environment variable before build
        working-directory: ./frontend
        run: |
          echo "Checking REACT_APP_API_URL before build..."
          echo "Value ends with /api: $(echo '${{ secrets.REACT_APP_API_URL }}' | grep -q '/api$' && echo 'YES' || echo 'NO')"
          echo "Last 40 chars: ...$(echo '${{ secrets.REACT_APP_API_URL }}' | tail -c 41)"
          cat .env.production || echo ".env.production not found"
          
      - name: Clean build directory
        working-directory: ./frontend
        run: rm -rf build

      - name: Verify env var is set before build
        working-directory: ./frontend
        run: |
          echo "REACT_APP_API_URL value: $REACT_APP_API_URL"
          echo "Environment variable length: $(echo $REACT_APP_API_URL | wc -c)"

      - name: Build React app
        working-directory: ./frontend
        run: npm run build
        env:
          REACT_APP_API_URL: ${{ secrets.REACT_APP_API_URL }}
          NODE_ENV: production

      - name: Verify API URL in built files
        working-directory: ./frontend
        run: |
          echo "Checking if built files contain the API URL..."
          JS_FILE=$(find build/static/js -name "main.*.js" -not -name "*.map" | head -1)
          echo "Checking file: $JS_FILE"
          if grep -q "itsson-api.azurewebsites.net" "$JS_FILE"; then
            echo "Found API URL in built files"
            # Extract and show actual URLs found
            echo "All URLs found:"
            grep -o "https://itsson-api.azurewebsites.net[^\"]*" "$JS_FILE" | head -5 || true
            # Check if URL contains /api path
            if grep -q "itsson-api.azurewebsites.net/api" "$JS_FILE"; then
              echo "✅ URL correctly contains /api path"
            else
              echo "❌ URL missing /api path"
              echo "Sample URLs from file:"
              grep -o "itsson-api.azurewebsites.net[^\"}]*" "$JS_FILE" | head -3
            fi
          else
            echo "Could not find API URL in built files"
          fi

      - name: List build directory contents
        working-directory: ./frontend
        run: |
          echo "Build directory structure:"
          find build -type f | head -20
          echo ""
          echo "Number of files in build/: $(find build -type f | wc -l)"
          echo "Files in build/static/js/: $(find build/static/js -type f 2>/dev/null | wc -l || echo '0')"
          if [ -d "build/static/js" ]; then
            echo "Sample JS files:"
            ls -lh build/static/js/ | head -5
          fi
          
      - name: Deploy to Hostinger via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.HOSTINGER_FTP_SERVER }}
          username: ${{ secrets.HOSTINGER_FTP_USERNAME }}
          password: ${{ secrets.HOSTINGER_FTP_PASSWORD }}
          local-dir: ./frontend/build/
          server-dir: /public_html/
          log-level: verbose
          dangerous-clean-slate: true
          dry-run: false
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules**
